---
# =============================================================================
# CDX-E Playbook: Microsoft System Center Configuration Manager
# =============================================================================
# Purpose: Install and manage Microsoft System Center Configuration Manager
#          (SCCM / MECM) on designated hosts.
#
# Prerequisites:
#   - Domain must be deployed (domain_management.yml) before this playbook.
#   - SQL Server must be deployed (sql_management.yml) before this playbook.
#   - SCCM setup media pre-staged on target hosts (see sccm_setup_path).
#   - SCCM prerequisites pre-staged (see sccm_prereqs_path).
#   - Windows ADK pre-staged (see sccm_adk_setup_path) or already installed.
#
# Roles:
#   - configure_vm                  — hostname, timezone, WinRM, PS policy
#   - install_windowsfeature        — prerequisites from windows_feature_sets['sccm_servers']
#   - deploy_configuration_manager  — ADK, AD prep, unattended install, readiness check
#
# Usage:
#   ansible-playbook playbooks/sccm_management.yml \
#     -e "exercise=OBSIDIAN_DAGGER" \
#     -e "@Secrets/credentials.yml" --ask-vault-pass
# =============================================================================

# ----------------------------------------------------------------------------
# Pre-play: load exercise configuration on the Ansible controller
# ----------------------------------------------------------------------------
- name: Load Exercise Configuration
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Load exercise configuration
      ansible.builtin.import_role:
        name: read_exercise_config

# ----------------------------------------------------------------------------
# Main play: SCCM deployment
# ----------------------------------------------------------------------------
- name: Microsoft System Center Configuration Manager
  hosts: sccm_servers
  gather_facts: false
  tags: [sccm, configuration_manager, services]

  vars_files:
    - "{{ playbook_dir }}/Secrets/credentials.yml"

  pre_tasks:
    - name: Import exercise facts from controller
      ansible.builtin.set_fact:
        scenario:         "{{ hostvars['localhost'].scenario }}"
        exercise_dir:     "{{ hostvars['localhost'].exercise_dir }}"
        virtual_machines: "{{ hostvars['localhost'].virtual_machines }}"

    - name: "[preflight] Skip — SCCM service phase disabled in scenario"
      ansible.builtin.meta: end_play
      when: not (scenario.phases.services.sccm | default(false) | bool)

    - name: "[preflight] Assert sccm_servers group is populated"
      ansible.builtin.assert:
        that: groups['sccm_servers'] | default([]) | length > 0
        fail_msg: >-
          sccm_servers group is empty. Ensure inventory_refresh has run and
          vms.yaml has at least one VM with ansible_group: sccm_servers.

  roles:
    - configure_vm
    - install_windowsfeature
    - deploy_configuration_manager
