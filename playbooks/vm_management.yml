---
# =============================================================================
# CDX-E Playbook: Virtual Machine Management
# =============================================================================
# Purpose: Deploy or destroy scenario-specific virtual machines in Proxmox
#          using Hashicorp Terraform. VMs are left in a powered-off state
#          after deployment; subsequent playbooks handle power-on and config.
#
# Roles:
#   - deploy_scenario   (action=deploy)
#   - destroy_scenario  (action=destroy)
#
# Usage:
#   # Deploy
#   ansible-playbook playbooks/vm_management.yml \
#     -e "exercise=OBSIDIAN_DAGGER action=deploy" \
#     -e "@secrets/credentials.yml"
#
#   # Destroy
#   ansible-playbook playbooks/vm_management.yml \
#     -e "exercise=OBSIDIAN_DAGGER action=destroy" \
#     -e "@secrets/credentials.yml"
# =============================================================================

- name: Virtual Machine Management
  hosts: localhost
  connection: local
  gather_facts: false
  tags: [terraform, vms]

  vars_files:
    - "{{ playbook_dir }}/secrets/credentials.yml"

  vars:
    vm_action: "{{ action | default('deploy') }}"

  pre_tasks:
    - name: "[preflight] Skip - terraform phase disabled in scenario"
      ansible.builtin.meta: end_play
      when: not (scenario.phases.terraform | default(true) | bool)

    - name: "[preflight] Assert virtual_machines fact is loaded"
      ansible.builtin.assert:
        that: virtual_machines is defined
        fail_msg: "virtual_machines fact not found. Run exercise_initiation first."

  roles:
    - role: deploy_scenario
      when: vm_action == 'deploy'
    - role: destroy_scenario
      when: vm_action == 'destroy'
