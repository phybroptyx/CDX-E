---
# =============================================================================
# Role: deploy_red_team
# =============================================================================
# Deploys Red Team / APT VMs to Proxmox via Terraform (bpg/proxmox provider).
# VM list comes from apt_vms (set by read_apt_config) — NOT from exercise vms.yaml.
# Uses a separate Terraform state from the main scenario deployment.
#
# Expects facts set by read_exercise_config and read_apt_config:
#   apt_vms       — list of VM objects from APTs/<apt>/vms.yaml
#   apt_name      — APT profile name (e.g., "GENERIC_RED")
#   scenario      — parsed scenario.yml
#   exercise_dir  — path to EXERCISES/<name>/
# =============================================================================

# ----------------------------------------------------------------------------
# Preflight
# ----------------------------------------------------------------------------
- name: Assert required facts are present
  ansible.builtin.assert:
    that:
      - apt_vms is defined
      - apt_name is defined
      - scenario is defined
      - exercise_dir is defined
    fail_msg: >-
      Required facts not found. Ensure read_exercise_config and read_apt_config
      run before deploy_red_team. Check red_team_deployment.yml pre-plays.

- name: Check Terraform is available
  ansible.builtin.command:
    cmd: "{{ terraform_binary }} version"
  register: _tf_version
  failed_when: _tf_version.rc != 0
  changed_when: false

# ----------------------------------------------------------------------------
# Build VM list from APT profile
# ----------------------------------------------------------------------------
- name: Build Red Team VM list from APT profile
  ansible.builtin.set_fact:
    _tf_vms: "{{ apt_vms }}"

- name: Assert at least one Red Team VM is defined in APT profile
  ansible.builtin.assert:
    that: _tf_vms | length > 0
    fail_msg: >-
      No VMs found in APT profile '{{ apt_name }}'.
      Check APTs/{{ apt_name }}/vms.yaml — virtual_machines must not be empty.

- name: Assert all Red Team VMs have Proxmox template IDs
  ansible.builtin.assert:
    that:
      - template_registry[item.template] is defined
      - template_registry[item.template].id is not none
    fail_msg: >-
      VM '{{ item.name }}' uses template '{{ item.template }}' which has no
      Proxmox VMID in template_registry. Build the template first.
  loop: "{{ _tf_vms }}"
  loop_control:
    label: "{{ item.name }} ({{ item.template }})"

# ----------------------------------------------------------------------------
# Resource pool — ensure it exists (may already be created by deploy_scenario)
# ----------------------------------------------------------------------------
- name: Ensure exercise resource pool exists
  ansible.builtin.uri:
    url: "{{ proxmox_api_url }}/pools"
    method: POST
    headers:
      Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
    body_format: form-urlencoded
    body:
      poolid: "EX_{{ scenario.exercise.name }}"
      comment: "Operation {{ scenario.exercise.name | replace('_', ' ') | title }}"
    validate_certs: "{{ proxmox_validate_certs }}"
    status_code: [200, 400, 500]   # 400/500 = pool already exists, continue

# ----------------------------------------------------------------------------
# Generate Terraform configuration
# ----------------------------------------------------------------------------
- name: Ensure Red Team Terraform directory exists
  ansible.builtin.file:
    path: "{{ exercise_dir }}/terraform_red_team"
    state: directory
    mode: '0755'

- name: Template providers.tf
  ansible.builtin.template:
    src: providers.tf.j2
    dest: "{{ exercise_dir }}/terraform_red_team/providers.tf"
    mode: '0644'

- name: Template main.tf
  ansible.builtin.template:
    src: main.tf.j2
    dest: "{{ exercise_dir }}/terraform_red_team/main.tf"
    mode: '0644'

- name: Template outputs.tf
  ansible.builtin.template:
    src: outputs.tf.j2
    dest: "{{ exercise_dir }}/terraform_red_team/outputs.tf"
    mode: '0644'

# ----------------------------------------------------------------------------
# Terraform init
# ----------------------------------------------------------------------------
- name: Terraform init
  ansible.builtin.command:
    cmd: "{{ terraform_binary }} init -input=false -upgrade"
    chdir: "{{ exercise_dir }}/terraform_red_team"
  register: _tf_init
  changed_when: >-
    'Downloading' in _tf_init.stdout or
    'Installing' in _tf_init.stdout

- name: Show Terraform init output
  ansible.builtin.debug:
    msg: "{{ _tf_init.stdout_lines }}"

# ----------------------------------------------------------------------------
# Terraform apply
# ----------------------------------------------------------------------------
- name: Terraform apply
  ansible.builtin.command:
    cmd: "{{ terraform_binary }} apply -auto-approve -input=false"
    chdir: "{{ exercise_dir }}/terraform_red_team"
  register: _tf_apply
  changed_when: >-
    'Apply complete!' in _tf_apply.stdout and
    '0 added, 0 changed, 0 destroyed' not in _tf_apply.stdout

- name: Show Terraform apply output
  ansible.builtin.debug:
    msg: "{{ _tf_apply.stdout_lines }}"

# ----------------------------------------------------------------------------
# Summary
# ----------------------------------------------------------------------------
- name: Red Team VM deployment summary
  ansible.builtin.debug:
    msg: |
      Red Team VM deployment complete.
      Exercise  : {{ scenario.exercise.name }}
      APT       : {{ apt_name }}
      VMs       : {{ _tf_vms | length }}
      VM list   : {{ _tf_vms | map(attribute='name') | join(', ') }}
      State     : {{ exercise_dir }}/terraform_red_team/terraform.tfstate
