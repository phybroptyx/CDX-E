# =============================================================================
# Terraform VM Configuration — Red Team / APT Infrastructure
# Exercise : {{ scenario.exercise.name }}
# APT      : {{ apt_name }}
# Auto-generated by CDX-E Ansible Pipeline — do not edit manually.
# =============================================================================

{% for vm in _tf_vms %}
# ── {{ vm.name }} ({{ vm.template }}) ──────────────────────────────────────────
resource "proxmox_virtual_environment_vm" "{{ vm.name | lower | regex_replace('[^a-z0-9]', '_') }}" {
  name      = "{{ vm.name }}"
  node_name = "{{ vm.proxmox.node | default(scenario.proxmox.node) }}"
  vm_id     = {{ vm.vmid }}
  pool_id   = "EX_{{ scenario.exercise.name }}"

  clone {
    vm_id        = {{ template_registry[vm.template].id }}
    node_name    = "{{ template_node }}"
    datastore_id = "{{ vm.proxmox.storage | default(scenario.proxmox.storage) }}"
    full         = {{ 'true' if (vm.clone_type | default(vm_clone_type)) == 'full' else 'false' }}
    retries      = 3
  }

  cpu {
    cores   = {{ vm.resources.cores }}
    sockets = {{ vm.resources.sockets | default(1) }}
    type    = "x86-64-v2-AES"
  }

  memory {
    dedicated = {{ vm.resources.memory_mb }}
  }

  # VMs are left powered-off after deployment.
  # The vm_power_management role handles power-on after inventory_refresh.
  started = false

  lifecycle {
    ignore_changes = [started]
  }
}
{% endfor %}
