---
# =============================================================================
# Role: revert_networking
# =============================================================================
# Restores base-only /etc/network/interfaces on each affected Proxmox node,
# removing all exercise-specific OVS bridges and CDX-I patch ports.
# Reloads networking via ifreload -a where the file changed.
#
# VyOS routers are persistent across exercises and are NOT reverted here.
# Bring them down or reconfigure them manually if needed.
#
# Expects facts set by read_exercise_config:
#   network_topology  — network_topology block from vms.yaml
#   scenario          — parsed scenario.yml
#   exercise_dir      — path to EXERCISES/<name>/
#
# Uses configure_networking/templates/interfaces.j2 (shared template).
# =============================================================================

# ----------------------------------------------------------------------------
# Preflight
# ----------------------------------------------------------------------------
- name: Assert required facts are present
  ansible.builtin.assert:
    that:
      - scenario is defined
      - exercise_dir is defined
    fail_msg: >-
      Required facts not found. Ensure read_exercise_config runs
      before revert_networking.

# ----------------------------------------------------------------------------
# Guard — no network topology to revert
# ----------------------------------------------------------------------------
- name: Skip — no network_topology.sites defined
  ansible.builtin.debug:
    msg: "No network_topology.sites defined. Nothing to revert."
  when: network_topology.sites is not defined or network_topology.sites | length == 0

- name: End play early — nothing to revert
  ansible.builtin.meta: end_play
  when: network_topology.sites is not defined or network_topology.sites | length == 0

# ----------------------------------------------------------------------------
# Determine affected nodes
# ----------------------------------------------------------------------------
- name: Build revert node list
  ansible.builtin.set_fact:
    _revert_nodes: >-
      {%- set nodes = [] -%}
      {%- for site in network_topology.sites | default([]) -%}
        {%- if site.node not in nodes -%}
          {%- set _ = nodes.append(site.node) -%}
        {%- endif -%}
      {%- endfor -%}
      {%- for bridge in network_topology.common_bridges | default([]) -%}
        {%- for node in bridge.nodes | default([]) -%}
          {%- if node not in nodes -%}
            {%- set _ = nodes.append(node) -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ nodes | sort }}

- name: Display revert plan
  ansible.builtin.debug:
    msg: >-
      Reverting to base network configuration on
      {{ _revert_nodes | length }} node(s): {{ _revert_nodes | join(', ') }}

# ----------------------------------------------------------------------------
# Re-template /etc/network/interfaces with empty site/bridge lists
# This removes all exercise OVS bridges and CDX-I patch ports.
# Shared template: configure_networking/templates/interfaces.j2
# ----------------------------------------------------------------------------
- name: Restore base /etc/network/interfaces on Proxmox node
  ansible.builtin.template:
    src: "{{ role_path | dirname }}/configure_networking/templates/interfaces.j2"
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: '0644'
    backup: true
  delegate_to: "{{ item }}"
  vars:
    node_name: "{{ item }}"
    node_sites: []
    node_common_bridges: []
    base_network: "{{ hostvars[item].base_network }}"
    exercise_name: ""
  loop: "{{ _revert_nodes }}"
  loop_control:
    label: "{{ item }}"
  register: _revert_results

# ----------------------------------------------------------------------------
# Reload networking on nodes where the file changed
# ----------------------------------------------------------------------------
- name: Reload networking on Proxmox node
  ansible.builtin.command: ifreload -a
  delegate_to: "{{ item.item }}"
  loop: "{{ _revert_results.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.changed | default(false)

# ----------------------------------------------------------------------------
# Summary
# ----------------------------------------------------------------------------
- name: revert_networking summary
  ansible.builtin.debug:
    msg: |
      revert_networking complete.
      Exercise          : {{ scenario.exercise.name }}
      Nodes reverted    : {{ _revert_results.results
                             | selectattr('changed') | list | length }}
      of {{ _revert_nodes | length }} total affected nodes.
      Base config restored. Exercise bridges removed.
