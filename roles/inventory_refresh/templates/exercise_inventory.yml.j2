# =============================================================================
# CDX-E Dynamic Exercise Inventory
# Auto-generated by inventory_refresh role — DO NOT edit manually.
# Exercise : {{ exercise }}
# Generated: {{ ansible_date_time.date | default('unknown') }}
#
# Connection vars by OS type:
#   Windows  → inventory/group_vars/windows_hosts.yml (WinRM)
#   Linux    → inventory/group_vars/linux_hosts.yml   (SSH)
#   VyOS     → inventory/group_vars/vyos_hosts.yml    (SSH, ansible_user=root)
# =============================================================================

all:
  children:

    # ─── All exercise VMs ─────────────────────────────────────────────────────
    # ansible_host:    management IP (empty string for DHCP-assigned VMs)
    # ansible_user:    cdxadmin (Windows/Linux) or root (VyOS)
    # ansible_os_type: windows | linux | vyos  (used by configuration roles)
    # vm_id:           Proxmox VMID
    # template:        template_registry key
    # ansible_group:   vms.yaml ansible_group value (informational)
    exercise_hosts:
      hosts:
{% for vm in virtual_machines %}
{% set _os = template_registry[vm.template].os_type %}
        {{ vm.name }}:
          ansible_host: "{{ _vm_ip_map[vm.name] | default('') }}"
          ansible_user: "{{ 'root' if _os == 'vyos' else 'cdxadmin' }}"
          ansible_os_type: "{{ _os }}"
          vm_id: {{ vm.vmid }}
          template: "{{ vm.template }}"
          ansible_group: "{{ vm.ansible_group }}"
{% endfor %}

    # ─── OS-type parent groups ─────────────────────────────────────────────────
    # Connection variables for each OS type live in inventory/group_vars/.
    # These groups allow roles to target all Windows or Linux hosts without
    # needing to enumerate individual role groups.

    windows_hosts:
{% if _vms_windows | length > 0 %}
      hosts:
{% for name in _vms_windows %}
        {{ name }}:
{% endfor %}
{% else %}
      hosts: {}
{% endif %}

    linux_hosts:
{% if _vms_linux | length > 0 %}
      hosts:
{% for name in _vms_linux %}
        {{ name }}:
{% endfor %}
{% else %}
      hosts: {}
{% endif %}

    vyos_hosts:
{% if _vms_vyos | length > 0 %}
      hosts:
{% for name in _vms_vyos %}
        {{ name }}:
{% endfor %}
{% else %}
      hosts: {}
{% endif %}

    # ─── Role groups (from vms.yaml ansible_group field) ──────────────────────
    # Each VM belongs to exactly one role group. These groups are the primary
    # targeting mechanism for configuration roles (configure_active_directory,
    # configure_red_team, etc.).
{% for group, members in _inventory_groups.items() %}

    {{ group }}:
      hosts:
{% for name in members %}
        {{ name }}:
{% endfor %}
{% endfor %}
